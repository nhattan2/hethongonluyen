<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Thi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #b31217;
            --gold: #ffd700;
            --bg: linear-gradient(135deg, #d4145a 0%, #fbb03b 100%);
            --card: rgba(255, 255, 255, 0.98);
            --text: #2d3436;
            --input-bg: #ffffff;
            --border: #dfe6e9;
            --success: #27ae60;
            --accent: #e74c3c;
        }

        body.dark-mode {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --input-bg: #2d2d2d;
            --border: #404040;
            --primary: #ff4757;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            user-select: none;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            width: 98%;
            max-width: 850px;
            height: 96vh;
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            position: relative;
        }

        .copyright-tag {
            font-size: 0.75rem;
            text-align: center;
            margin-top: 10px;
            color: #777;
        }

        .copyright-tag a {
            color: var(--primary);
            text-decoration: none;
            font-weight: bold;
        }

        .btn-file {
            padding: 10px 20px;
            border: 2px solid var(--primary);
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text);
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-file.selected {
            background: var(--primary) !important;
            color: var(--gold) !important;
            border-color: var(--gold) !important;
            box-shadow: 0 0 15px rgba(179, 18, 23, 0.4);
        }

        .mode-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-card {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            background: var(--input-bg);
        }

        .mode-card.active {
            border-color: var(--primary);
            background: rgba(179, 18, 23, 0.1);
            color: var(--primary);
        }

        #render-target {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .option {
            padding: 12px 18px;
            border: 2px solid var(--border);
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--text);
        }

        .option.correct {
            background: var(--success) !important;
            color: white !important;
        }

        .option.wrong {
            background: var(--accent) !important;
            color: white !important;
        }

        .option.selected-now {
            border-color: var(--primary);
            background: rgba(179, 18, 23, 0.05);
        }

        .q-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));
            gap: 6px;
            margin-bottom: 10px;
            max-height: 100px;
            overflow-y: auto;
            background: var(--input-bg);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .q-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: #fff;
            color: #333;
            cursor: pointer;
        }

        .q-item.correct-grid {
            background: var(--success) !important;
            color: white !important;
        }

        .q-item.wrong-grid {
            background: var(--accent) !important;
            color: white !important;
        }

        .q-item.done-working {
            background: var(--primary) !important;
            color: white !important;
        }

        .q-item.current {
            border: 2px solid var(--text);
            transform: scale(1.1);
        }

        .nav-area {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
        }

        .btn-main {
            background: var(--primary);
            color: #fff;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--text);
        }

        .input-group input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
        }
    </style>
</head>

<body oncontextmenu="return false;">
    <div class="container">
        <div style="text-align: center; position: relative; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 1.4rem; color: var(--primary); letter-spacing: 1px;">H·ªÜ TH·ªêNG THI</h2>
            <button onclick="toggleDarkMode()"
                style="position: absolute; right: 0; top: 0; background: none; border: none; cursor: pointer; font-size: 1.2rem;">üåì</button>
        </div>

        <div id="setup-area">
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                <button class="btn-file" id="btn-d1" onclick="loadFile('gdqp01.docx', 'btn-d1', 'GDQP 01')">GDQP 01</button>
                <button class="btn-file" id="btn-d2" onclick="loadFile('gdqp02.docx', 'btn-d2', 'GDQP 02')">GDQP 02</button>
            </div>

            <div id="ready-area" style="display: none; flex-direction: column;">
                <div class="mode-box">
                    <div class="mode-card active" id="m-test" onclick="setMode('test')">THI TH·ª¨</div>
                    <div class="mode-card" id="m-practice" onclick="setMode('practice')">LUY·ªÜN T·∫¨P</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label id="limit-label">S·ªë c√¢u h·ªèi</label>
                        <input type="number" id="limitQ" placeholder="Nh·∫≠p s·ªë c√¢u">
                    </div>
                    <div class="input-group" id="time-input-box">
                        <label>Th·ªùi gian (ph√∫t)</label>
                        <input type="number" id="duration" value="15">
                    </div>
                </div>
                <button class="btn-main" onclick="startQuiz()">B·∫ÆT ƒê·∫¶U</button>
            </div>
        </div>

        <div id="quiz-area" style="display: none; flex-direction: column; height: 100%;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span id="timer" style="font-weight: 900; color: var(--primary);">00:00</span>
                <span id="count-txt" style="font-weight: bold;">1/20</span>
            </div>
            <div id="render-target"></div>
            <div class="q-grid" id="q-grid"></div>
            <div class="nav-area">
                <button onclick="go(-1)" class="nav-btn">QUAY L·∫†I</button>
                <button onclick="go(1)" class="nav-btn">TI·∫æP THEO</button>
                <button id="submit-btn" class="nav-btn"
                    style="background: var(--primary); color: white; border: none;">N·ªòP B√ÄI</button>
            </div>
        </div>

        <div id="result-area"
            style="display: none; text-align: center; flex-direction: column; justify-content: center; height: 100%;">
            <h1 id="final-score" style="font-size: 4rem; color: var(--primary); margin: 0;">0.0</h1>
            <p id="stats" style="font-weight: bold;"></p>
            <button class="btn-main" onclick="reviewMode()">XEM L·∫†I</button>
            <button class="btn-main" style="background: #666; margin-top: 10px;"
                onclick="location.reload()">THO√ÅT</button>
        </div>

        <div class="copyright-tag">
            B·∫£n quy·ªÅn c·ªßa T√¢n v√† <a href="https://t.me/Dai_Hoc_Duy_Tan" target="_blank">https://t.me/Dai_Hoc_Duy_Tan</a>
        </div>
    </div>

    <script>
        let bank = [], quiz = [], current = 0, userAnswers = {}, active = false, timeLeft = 0, timerInterval;
        let mode = 'test', isReview = false, currentFileName = "";
        let blurTimeout;

        const isTelegram = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData !== "";

        // CH·ªêNG GIAN L·∫¨N: CH·∫∂N PH√çM V√Ä M·∫§T T·∫¨P TRUNG
        window.addEventListener('keydown', function (e) {
            const blockedKeys = ['F12', 'Escape', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Tab', 'Meta'];
            if (active && mode === 'test' && (blockedKeys.includes(e.key) || e.ctrlKey || e.shiftKey)) {
                e.preventDefault();
                if (e.key === 'Escape') checkEsc();
                return false;
            }
        });

        function checkEsc() {
            // Ch·ªâ check Fullscreen tho√°t ra n·∫øu KH√îNG ph·∫£i Telegram (v√¨ Tele kh√¥ng c√≥ fullscreen th·ª±c th·ª•)
            if (!isTelegram && !document.fullscreenElement && active && mode === 'test') {
                Swal.fire({ title: 'C·∫£nh b√°o!', text: 'B·∫°n ƒë√£ tho√°t ch·∫ø ƒë·ªô thi!', icon: 'error' }).then(() => showResult());
            }
        }
        document.addEventListener('fullscreenchange', checkEsc);

        // Ch·ªëng gian l·∫≠n cho c·∫£ Chrome v√† Telegram v·ªõi c∆° ch·∫ø Delay ch·ªëng kh√≥a nh·∫ßm
        window.addEventListener('blur', () => {
            if (active && mode === 'test') {
                blurTimeout = setTimeout(() => {
                    if (active && mode === 'test') {
                        Swal.fire({ title: 'VI PH·∫†M!', text: 'R·ªùi kh·ªèi m√†n h√¨nh thi!', icon: 'error' }).then(() => showResult());
                    }
                }, 1500); // ƒê·ª£i 1.5s ƒë·ªÉ l·ªçc c√°c l·ªói m·∫•t focus gi·∫£ tr√™n Telegram
            }
        });

        window.addEventListener('focus', () => { clearTimeout(blurTimeout); });

        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            document.getElementById('m-' + m).classList.add('active');
            document.getElementById('time-input-box').style.visibility = (m === 'practice') ? 'hidden' : 'visible';
        }

        function loadFile(path, id, name) {
            currentFileName = name;
            document.querySelectorAll('.btn-file').forEach(b => b.classList.remove('selected'));
            document.getElementById(id).classList.add('selected');
            fetch(path).then(r => r.arrayBuffer()).then(ab => mammoth.convertToHtml({ arrayBuffer: ab }).then(res => {
                parseData(res.value);
                document.getElementById('ready-area').style.display = 'flex';
                document.getElementById('limitQ').value = bank.length;
                document.getElementById('limit-label').innerText = `S·ªë c√¢u h·ªèi (t·ªëi ƒëa ${bank.length})`;
            })).catch(() => Swal.fire("L·ªói", "Kh√¥ng th·ªÉ t·∫£i file ƒë·ªÅ!", "error"));
        }

        function parseData(html) {
            bank = []; let div = document.createElement('div'); div.innerHTML = html;
            let ps = div.querySelectorAll('p'), cur = null;
            ps.forEach(p => {
                let txt = p.textContent.trim();
                if (/^C√¢u\s*\d+/.test(txt)) { if (cur) bank.push(cur); cur = { q: txt, o: [], a: "" }; }
                else if (/^[A-D][:.]/.test(txt) && cur) {
                    let op = txt.replace(/^[A-D][:.]\s*/, ''); cur.o.push(op);
                    if (p.querySelector('b, strong')) cur.a = op;
                }
            });
            if (cur) bank.push(cur);
        }

        function startQuiz() {
            let limit = parseInt(document.getElementById('limitQ').value) || bank.length;
            quiz = bank.sort(() => .5 - Math.random()).slice(0, limit);
            if (mode === 'test') {
                timeLeft = parseInt(document.getElementById('duration').value) * 60;
                startTimer();
                if (!isTelegram) document.documentElement.requestFullscreen().catch(() => { });
            }
            active = true; current = 0; userAnswers = {}; isReview = false;
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'flex';
            renderQuestion(); renderGrid();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' + s : s}`;
                if (timeLeft-- <= 0) showResult();
            }, 1000);
        }

        function renderQuestion() {
            let q = quiz[current];
            let html = `<div class="question-text">${q.q}</div>`;
            q.o.forEach(o => {
                let cls = "";
                if (isReview || (mode === 'practice' && userAnswers[current])) {
                    if (o === q.a) cls = "correct";
                    else if (userAnswers[current] === o) cls = "wrong";
                } else if (userAnswers[current] === o) { cls = "selected-now"; }
                html += `<div class="option ${cls}" onclick="selectOption('${o.replace(/'/g, "\\'")}')">${o}</div>`;
            });
            document.getElementById('render-target').innerHTML = html;
            document.getElementById('count-txt').innerText = `${current + 1}/${quiz.length}`;
            updateGrid();
        }

        function selectOption(val) {
            if (isReview || (mode === 'practice' && userAnswers[current])) return;
            userAnswers[current] = val;
            renderQuestion();
            if (mode === 'test') setTimeout(() => go(1), 300);
        }

        function renderGrid() {
            document.getElementById('q-grid').innerHTML = quiz.map((_, i) => `<div class="q-item" id="q-i-${i}" onclick="jumpTo(${i})">${i + 1}</div>`).join('');
        }

        function updateGrid() {
            document.querySelectorAll('.q-item').forEach((el, i) => {
                el.className = 'q-item';
                if (i === current) el.classList.add('current');
                if (userAnswers[i]) {
                    if (isReview || mode === 'practice') {
                        if (userAnswers[i] === quiz[i].a) el.classList.add('correct-grid');
                        else el.classList.add('wrong-grid');
                    } else { el.classList.add('done-working'); }
                }
            });
        }

        function jumpTo(i) { current = i; renderQuestion(); }
        function go(s) { if (current + s >= 0 && current + s < quiz.length) { current += s; renderQuestion(); } }

        function showResult() {
            active = false; clearInterval(timerInterval);
            if (!isTelegram && document.fullscreenElement) document.exitFullscreen();
            let correct = 0; quiz.forEach((q, i) => { if (userAnswers[i] === q.a) correct++; });
            document.getElementById('quiz-area').style.display = 'none';
            document.getElementById('result-area').style.display = 'flex';
            document.getElementById('final-score').innerText = (correct / quiz.length * 10).toFixed(1);
            document.getElementById('stats').innerText = `ƒê√∫ng ${correct}/${quiz.length} c√¢u`;
        }

        document.getElementById('submit-btn').onclick = () => {
            Swal.fire({ title: 'N·ªôp b√†i?', icon: 'question', showCancelButton: true }).then(r => { if (r.isConfirmed) showResult(); });
        };

        function reviewMode() {
            isReview = true; current = 0;
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'flex';
            renderQuestion();
        }
    </script>
</body>

</html>
